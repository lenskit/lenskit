<?xml version="1.0" encoding="UTF-8"?>
<project name="lenskit-archetype-test"
         xmlns:artifact="antlib:org.apache.maven.artifact.ant">

  <property name="mldata.zipfile" value="${project.build.directory}/data/ml100k.zip"/>

  <macrodef name="test-archetype">
    <attribute name="archetype" default="NOT SET"/>
    <attribute name="dldir" default=""/>
    <sequential>
      <artifact:mvn mavenHome="${maven.home}"
                    fork="true"
                    failonerror="true"
                    dir="${archetype.test.directory}">
        <arg value="--settings=${basedir}/src/test/settings.xml"/>
        <arg value="-Dmock.repository.url=${mock.repository.url}"/>
        <arg value="-Dtest.repo.directory=${test.repo.directory}"/>
        <arg value="archetype:generate"/>
        <arg value="-DarchetypeGroupId=org.grouplens.lenskit"/>
        <arg value="-DarchetypeArtifactId=lenskit-archetype-@{archetype}"/>
        <arg value="-DarchetypeVersion=${lenskit.version}"/>
        <arg value="-DarchetypeCatalog=internal,local"/>
        <arg value="-DarchetypeRepository=${mock.repository.url}"/>
        <arg value="-DgroupId=org.grouplens.lenskit.it"/>
        <arg value="-DartifactId=test-@{archetype}"/>
        <arg value="-Dversion=1-SNAPSHOT"/>
      </artifact:mvn>

      <mkdir dir="${archetype.test.directory}/test-@{archetype}/@{dldir}"/>
      <copy file="${mldata.zipfile}"
            todir="${archetype.test.directory}/test-@{archetype}/@{dldir}"/>

      <artifact:mvn mavenHome="${maven.home}"
                    fork="true"
                    failonerror="true"
                    dir="${archetype.test.directory}/test-@{archetype}">
        <arg value="--settings=${basedir}/src/test/settings.xml"/>
        <arg value="-e"/>
        <arg value="-Dmock.repository.url=${mock.repository.url}"/>
        <arg value="-Dtest.repo.directory=${test.repo.directory}"/>
        <arg value="-Dgrouplens.mldata.acknowledge=${grouplens.mldata.acknowledge}"/>
        <arg value="-Dlenskit.eval.threadCount=${lenskit.eval.threadCount}"/>
        <arg value="-Drscript.executable=${rscript.executable}"/>
        <arg value="lenskit-publish"/>
      </artifact:mvn>
    </sequential>
  </macrodef>

  <!-- blow away and recreate archetype test directory. -->
  <target name="init">
    <delete dir="${archetype.test.directory}"
            failonerror="false"/>
    <mkdir dir="${archetype.test.directory}"/>
  </target>

  <target name="test-simple" depends="init">
    <test-archetype archetype="simple-analysis"/>
  </target>

  <target name="test-fancy" depends="init">
    <test-archetype archetype="fancy-analysis"
                    dldir="target/data"/>
  </target>

  <target name="all-tests" depends="test-simple,test-fancy"/>
</project>
