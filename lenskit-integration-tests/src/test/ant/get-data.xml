<?xml version="1.0" encoding="UTF-8"?>
<project name="lenskit-itest-prep">
  <!-- Set up the MovieLens 100K data. If data.movielens.100k is set, it is used
       as the location of the data; otherwise, it is downloaded from the GroupLens
       web site. -->

  <property name="mldata.zipfile" value="${project.build.directory}/data/ml100k.zip"/>

  <target name="check-100k">
    <condition property="data.movielens.100k.avail">
      <available file="${data.movielens.100k}/u.data"/>
    </condition>
    <!-- Check if the ML-100K data dir is outside target/.
         If it is, we won't download and extract. -->
    <condition property="data.movielens.100k.external">
      <scriptcondition language="javascript" value="false">
        var dir = project.getProperty("data.movielens.100k");
        var tgtDir = project.getProperty("project.build.directory");
        self.setValue(!dir.startsWith(tgtDir));
      </scriptcondition>
    </condition>
    <echo message="ML-100K in ${data.movielens.100k}"/>
  </target>

  <target name="download-100k" depends="check-100k" unless="data.movielens.100k.external">

    <fail message="This analysis makes use of the MovieLens 100K data
         set from GroupLens Research. Use of this data set is restricted to
         non-commercial purposes and is only permitted in accordance with the
         license terms. To use this data in LensKit's automated tests, set the
         `grouplens.mldata.acknowledge' property to `yes' to indicate you
         acknowledge the usage license.  More information is available at
         &lt;http://www.grouplens.org/node/73&gt;.">

      <condition>
        <not>
          <equals arg1="${grouplens.mldata.acknowledge}" arg2="yes"
                  trim="true" casesensitive="false"/>
        </not>
      </condition>
    </fail>
    <mkdir dir="${project.build.directory}/data"/>
    <get src="http://www.grouplens.org/system/files/ml-100k.zip"
         dest="${mldata.zipfile}"
         skipexisting="true"/>
  </target>

  <target name="extract-100k" depends="check-100k,download-100k" unless="data.movielens.100k.avail">
    <!-- If we got this far, and the data is external (not in target/), we don't want to
         download. Fail with an error message instead. -->
    <fail message="No ML-100K in ${data.movielens.100k}"
          if="data.movielens.100k.external"/>
    <unzip src="${mldata.zipfile}" dest="${data.movielens.100k}">
      <patternset>
        <include name="ml-100k/*"/>
      </patternset>
      <mapper type="flatten"/>
    </unzip>
  </target>

  <target name="fetch-100k" depends="extract-100k"/>
</project>

